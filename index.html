<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8">
  <meta http-equiv="X-UA-Compatible" content="IE=edge">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>Facebook Challenge</title>
  <link rel="stylesheet" type="text/css" href="style.css">
</head>
<body>
  <div class="hours">
    <div class="full-hour">9:00 <span class="period">am</span></div>
    <div class="half-hour">9:30</div>
    <div class="full-hour">10:00 <span class="period">am</span></div>
    <div class="half-hour">10:30</div>
    <div class="full-hour">11:00 <span class="period">am</span></div>
    <div class="half-hour">11:30</div>
    <div class="full-hour">12:00 <span class="period">pm</span></div>
    <div class="half-hour">12:30</div>
    <div class="full-hour">1:00 <span class="period">pm</span></div>
    <div class="half-hour">1:30</div>
    <div class="full-hour">2:00 <span class="period">pm</span></div>
    <div class="half-hour">2:30</div>
    <div class="full-hour">3:00 <span class="period">pm</span></div>
    <div class="half-hour">3:30</div>
    <div class="full-hour">4:00 <span class="period">pm</span></div>
    <div class="half-hour">4:30</div>
    <div class="full-hour">5:00 <span class="period">pm</span></div>
    <div class="half-hour">5:30</div>
    <div class="full-hour">6:00 <span class="period">pm</span></div>
    <div class="half-hour">6:30</div>
    <div class="full-hour">7:00 <span class="period">pm</span></div>
    <div class="half-hour">7:30</div>
    <div class="full-hour">8:00 <span class="period">pm</span></div>
    <div class="half-hour">8:30</div>
    <div class="full-hour">9:00 <span class="period">pm</span></div>
  </div>

  <div class="calendar">
  </div>
  <input type="number" id="num" value="15">
  <button id="generate">Generate</button>

  <script type="text/html" id="event-template">
    <div class="event">
      <div class="title">Sample Item</div>
      <div class="description">Sample Location</div>
    </div>
  </script>

  <script src="jquery-2.1.1.js"></script>
  <script>
    (function () {
      window.layOutDay = layOutDay;

      var eventTemplate = $('#event-template').html();
      var calendar = $('.calendar');
      var maxWidth = 600;
      var elements = [];

      function layOutDay(events) {
        elements.forEach(function (element) {
          element.remove();
        });
        elements = [];

        // Do nothing if it's not a valid array.
        if (!Array.isArray(events)) return;

        var map = new Array(721);

        events.sort(function byRange(a, b) {
          return (b.end - b.start) - (a.end - a.start);
        });

        events.forEach(function (event) {
          // Prepare map.
          for(var i = event.start; i <= event.end; i++) {
            map[i] = map[i] || [];
            map[i].push(event);
          }

          // Add dimension and neighbours.
          event.dimension = getMaxNeighbours(map, event);
          event.neighbours = getNeighbourgs(map, event);
        });

        events.forEach(function (event) {
          // Sort neighbours.
          event.neighbours.sort(function (a, b) {
            return (a.position || 0) - (b.position || 0);
          });

          event.position = event.neighbours.reduce(function (position, neigbour) {
            if (neigbour.position === position) position++;
            return position;
          }, 0);

          if (event.position >= event.dimension) {
            event.dimension ++;
          }
        });

        events.forEach(synchronizeDimension);
        events.forEach(synchronizeDimension);

        function synchronizeDimension(event) {
          event.neighbours.forEach(function (neigbour) {
            if (neigbour.dimension < event.dimension) {
              neigbour.dimension = event.dimension;
            }
          });
        }

        // Add each event to the calendar.
        events.forEach(createEvent);

        function createEvent(event, index) {
          var w = maxWidth * (1 / event.dimension) - 22;
          var l = maxWidth * (event.position / event.dimension);

          var element = $(eventTemplate);
          element.find('.title').html(index);
          element.css('top', event.start + 'px');
          element.css('height', (event.end - event.start - 10) + 'px');
          element.css('width', w);
          element.css('margin-left', l);
          calendar.append(element);
          elements.push(element);
        }

        function getNeighbourgs(map, event) {
          return events.filter(function (ev) {
            return intersects(ev, event);
          });
        }

        function getMaxNeighbours(map, event) {
          return Math.max.apply(null, map.slice(event.start, event.end).map(function (ar) {
            return ar ? ar.length : 0;
          }));
        }
      }
    }());

    $('#generate').on('click', function () {
      var num = +$('#num').val();
      generate(num);
    });

    function intersects(a, b) {
      return !((a.end < b.start) || (b.end < a.start));
     }

    function random(min, max) {
      return Math.floor(Math.random() * (max - min + 1)) + min;
    }

    function generate(num) {
      var events = [];
      for(var i = 0; i < num; i++) {
        var event = {start: random(0, 690)};
        event.end = random(event.start + 20, 720);
        events.push(event);
      }
      // console.log('SET OF EVENTS', JSON.stringify(events));
      console.time('layoutDay ' + num);
      layOutDay(events);
      console.timeEnd('layoutDay ' + num);
    }

    generate(600);

    // layOutDay( [{"start":401,"end":496},{"start":77,"end":260},{"start":640,"end":703},{"start":201,"end":496},{"start":303,"end":579},{"start":436,"end":597},{"start":311,"end":638},{"start":500,"end":641},{"start":445,"end":680},{"start":271,"end":318},{"start":343,"end":450},{"start":274,"end":296},{"start":349,"end":444},{"start":307,"end":624},{"start":312,"end":422}]    );

    // layOutDay([{"start":271,"end":326},{"start":105,"end":309},{"start":115,"end":437},{"start":587,"end":657},{"start":251,"end":406},{"start":402,"end":640},{"start":77,"end":517},{"start":157,"end":710},{"start":363,"end":427},{"start":129,"end":508},{"start":557,"end":588},{"start":51,"end":389},{"start":336,"end":718},{"start":413,"end":684},{"start":567,"end":671}] );
    // layOutDay([{"start":201,"end":478},{"start":505,"end":611},{"start":328,"end":561},{"start":92,"end":464},{"start":26,"end":370},{"start":372,"end":442},{"start":531,"end":690},{"start":461,"end":622},{"start":223,"end":399},{"start":376,"end":441},{"start":455,"end":602},{"start":486,"end":617},{"start":487,"end":720},{"start":630,"end":667},{"start":93,"end":275}] );

    // layOutDay([{start: 30, end: 150}, {start: 540, end: 600},  {start: 540, end: 600}, {start: 540, end: 600}, {start: 540, end: 600}, {start: 560, end: 600}, {start: 560, end: 620}, {start: 560, end: 620}, {start: 10, end: 670}, {start: 610, end: 670}, {start: 610, end: 670}]);

    // layOutDay([{start: 30, end: 150}, {start: 540, end: 600},  {start: 540, end: 600}, {start: 540, end: 600}, {start: 140, end: 600}, {start: 140, end: 600}, {start: 560, end: 600}, {start: 560, end: 620}, {start: 560, end: 620}, {start: 10, end: 670}, {start: 610, end: 670}, {start: 610, end: 670}]);

    // layOutDay([{start: 30, end: 150}, {start: 540, end: 600}, {start: 560, end: 620}, {start: 610, end: 670}]);
  </script>
</body>
</html>
